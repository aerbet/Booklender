<!doctype html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<meta content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
		  name="viewport">
	<meta content="ie=edge" http-equiv="X-UA-Compatible">
	<title>Библиотека - Список книг</title>
	<link href="css/freemarker.css" rel="stylesheet">
</head>
<body>

<div class="container">
	<div class="card">
		<h1>Библиотека</h1>

		<table class="book-table">
			<thead>
			<tr>
				<th>ID</th>
				<th>Название</th>
				<th>Автор</th>
				<th>Статус</th>
				<th>Сотрудник</th>
				<th>Действие</th>
			</tr>
			</thead>
			<tbody>
			<#list booksList as book>
			<tr>
				<td>${book.id}</td>
				<td><strong>${book.title}</strong></td>
				<td>${book.author}</td>
				<td>
					<#if book.status == "Available">
					<span class="badge available">Доступна</span>
					<#else>
					<span class="badge issued">Выдана</span>
				</#if>
				</td>
				<td>
					<#if book.status != "Available">
					<#assign holderId = "">
					<#-- 1. Ищем ID сотрудника в новой карте записей -->
					<#list employeeRecordsMap?keys as employeeId>
					<#list employeeRecordsMap[employeeId].currentBooks![] as currentBook>
					<#if currentBook.id == book.id>
					<#assign holderId = employeeId>
					<#break>
				</#if>
			</#list>
			<#if holderId != "">
			<#break>
			</#if>
		</#list>

		<#-- 2. Если ID найден, ищем объект Employee в usersMap -->
		<#if holderId != "">
		<#assign holderEmployee = usersMap[holderId]!>
		<#if holderEmployee??>
		<#assign holderName = "${holderEmployee.firstName} ${holderEmployee.lastName}">
		<a href="/employee?id=${holderEmployee.id}">${holderName}</a>
		<#else>
		<span style="color: gray;">(Неизвестен)</span>
	</#if>
	<#else>
	<span style="color: gray;">(Неизвестен)</span>
</#if>
</#if>
</td>
<td>
	<a href="/book?id=${book.id}" class="btn">Подробнее</a>
</td>
</tr>
</#list>
</tbody>
</table>
</div>
</div>

<div class="container">
	<div class="card">
		<h1>Список сотрудников</h1>

		<table class="book-table">
			<thead>
			<tr>
				<th>Сотрудник</th>
				<th>Должность</th>
				<th>Текущие книги</th>
				<th>Прочитанные книги</th>
				<th>Действия</th>
			</tr>
			</thead>
			<tbody>
			<#list employeeRecords as recordData>
			<tr>
				<td><a href="/employee?id=${recordData.employee.id}">
					${recordData.employee.firstName} ${recordData.employee.lastName}
				</a></td>
				<td>${recordData.employee.position}</td>

				<td>
					<#list recordData.records.currentBooks![] as book>
					• ${book.title} <#sep><br></#sep>
			</#list>
			</td>

			<td>
				<#list recordData.records.previousBooks![] as book>
				✔ ${book.title} <#sep><br></#sep>
			</#list>
			</td>

			<td>
				<a href="/books" class="btn">Открыть</a>
			</td>
			</tr>
		</#list>
		</tbody>
		</table>
	</div>
</div>

</body>
</html>
